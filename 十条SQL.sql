-- 1. 查询出所有欠费用户
SELECT DISTINCT CUSTOMER_ID 用户ID, CUSTOMER_NAME 用户姓名, PAY_STATE 缴费类型,DEVICE_ID 设备ID
FROM CUSTOMER
      JOIN POWER_RATE_LIST USING (CUSTOMER_ID)
WHERE PAY_STATE != 1;

-- 2. 查询出拥有超过2个设备的用户
SELECT CUSTOMER_ID 用户ID, CUSTOMER_NAME 用户姓名, count(DEVICE_ID) 设备数量
FROM CUSTOMER
      JOIN DEVICE USING (CUSTOMER_ID)
GROUP BY CUSTOMER_ID, CUSTOMER_NAME
HAVING count(DEVICE_ID) > 2;

-- 3. 统计电力企业某天的总应收费用、实收费用
-- 2018-8-20 为例的数据
SELECT *  FROM
   (SELECT SUM(PAID_FEE) 总应收费用
    FROM POWER_RATE_LIST
    WHERE (TO_CHAR(PAYABLE_DATE, 'yyyymmdd') <= 20180820 AND PAY_STATE != 1))
   NATURAL JOIN
    (SELECT SUM(PAY_AMOUNT) 总实收费用
     FROM PAY_LOG
     WHERE (TO_CHAR(PAY_TIME, 'yyyymmdd') = 20180820));

-- 4. 查询出所有欠费超过半年的用户
SELECT CUSTOMER_NAME 用户名称, TO_CHAR(PAYABLE_DATE, 'yyyy/mm/dd') 应缴日期
FROM POWER_RATE_LIST
      JOIN CUSTOMER USING (CUSTOMER_ID)
WHERE PAY_STATE != 1
 AND (TO_DATE(SYSDATE) - TO_DATE(PAYABLE_DATE) > 180);

-- 5. 查询任意用户的欠费总额
SELECT CUSTOMER_NAME 用户名称, (sum(ACTUAL_FEE) - sum(ALREADY_FEE)) 欠费金额
FROM POWER_RATE_LIST
      JOIN CUSTOMER USING (CUSTOMER_ID)
WHERE PAY_STATE != 1
GROUP BY CUSTOMER_ID, CUSTOMER_NAME
ORDER BY 欠费金额 DESC;

-- 6. 查询出某个月用电量最高的3名用户
-- 2018年6月为例
SELECT *
FROM (SELECT CUSTOMER_NAME 用户姓名, END_NUMBER - BEGIN_NUMBER 用电量
     FROM POWER_RATE_LIST
            JOIN CUSTOMER USING (CUSTOMER_ID)
     WHERE TO_CHAR(MT_DATE, 'yyyymm') = 201807
     ORDER BY 用电量 DESC)
WHERE ROWNUM <= 3;

-- 7. 查询出电力企业某个月哪天的缴费人数最多
-- 2018-8月 为例
SELECT TO_CHAR(PAY_TIME, 'yyyy-mm-dd') 缴费日期, COUNT(TO_DATE(PAY_TIME)) 缴费人数
FROM PAY_LOG
WHERE PAY_TYPE != 0
 AND TO_CHAR(PAY_TIME, 'yyyymm') = 201808
GROUP BY TO_CHAR(PAY_TIME, 'yyyy-mm-dd')
HAVING (COUNT(TO_DATE(PAY_TIME)) =
       (SELECT MAX(COUNT(TO_DATE(PAY_TIME)))
        FROM PAY_LOG
        WHERE PAY_TYPE != 0
        GROUP BY TO_CHAR(PAY_TIME, 'yyyy-mm-dd')));

-- 8. 按设备类型使用人数从高到低排序查询列出设备类型，使用人数
SELECT DEVICE_TYPE AS 设备类型, COUNT(DISTINCT CUSTOMER_ID) AS 使用人数
FROM CUSTOMER
      JOIN DEVICE USING (CUSTOMER_ID)
GROUP BY DEVICE_TYPE
ORDER BY 使用人数 DESC;

-- 9. 统计每个月各银行缴费人次，从高到低排序。
SELECT COUNT(TO_CHAR(TRANSFER_TIME, 'yyyy-mm')) 缴费人次, BANK_NAME 银行名称, TO_CHAR(TRANSFER_TIME, 'yyyy-mm') 缴费年月
FROM BANK
      NATURAL JOIN BANK_TRANSFER_RECORD
WHERE TO_CHAR(TRANSFER_TIME, 'yyyy-mm') = '2018-08'
GROUP BY BANK_ID, TO_CHAR(TRANSFER_TIME, 'yyyy-mm'), BANK_NAME
ORDER BY 缴费人次 DESC;

-- 10. 查询出电力企业所有新增用户（使用设备不足半年）
SELECT CUSTOMER_NAME 用户姓名, TO_CHAR(MIN(MT_DATE), 'yyyy/mm/dd') 首次抄表日期
FROM CUSTOMER
       JOIN METER_LOG USING (CUSTOMER_ID)
GROUP BY CUSTOMER_ID, CUSTOMER_NAME
HAVING TO_DATE(SYSDATE) - TO_DATE(MIN(MT_DATE)) < 180;


